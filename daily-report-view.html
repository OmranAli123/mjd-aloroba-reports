<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Ø¹Ø§Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© - Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ Ø«Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±</title>
  <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@500&display=swap" rel="stylesheet">
  <style>
    :root{--c1:#17a2b8;--c2:#28a745;--c3:#6c757d;--c4:#ffc107;--c5:#dc3545}
    body{font-family:'El Messiri',sans-serif;background:#f7f7fa;color:#333;margin:20px;line-height:1.7}
    .page{max-width:1120px;margin:auto}
    .top-bar{background:#fff;padding:15px 20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:20px;display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between}
    .top-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-weight:600}
    select{padding:6px 10px;border-radius:6px;border:1px solid #ccc;min-width:210px;font-family:inherit;font-size:.95rem}
    .btn{background:#007bff;color:#fff;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:.9rem}
    .btn:hover{background:#0056b3}
    .container{background:#fff;padding:22px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);margin-bottom:22px}
    h1{text-align:center;border-bottom:3px solid var(--c1);padding-bottom:10px;color:var(--c1);margin-top:0}
    h2{color:var(--c2);border-bottom:2px solid #ddd;padding-bottom:6px;margin-top:18px}
    table{width:100%;border-collapse:collapse;margin:10px 0}
    th,td{border:1px solid #dee2e6;padding:8px;vertical-align:middle}
    th{background:var(--c1);color:#fff;text-align:center}
    .summary th{background:var(--c3)}
    .resources th{background:var(--c4);color:#333}
    .safety th{background:var(--c5);color:#fff}
    .muted{color:#777;font-size:.9rem}
    .no-data{padding:14px;background:#f8f9fa;border:1px dashed #cfd6dc;border-radius:8px;color:#666}
    .header-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .readonly{background:#f9fbfd}
    @media print{.top-bar,.btn{display:none!important} body{margin:0;background:#fff} .page{max-width:none;margin:0}}
  </style>
</head>
<body>
<div class="page">

  <div class="top-bar">
    <div class="top-left">
      <label for="teamSelect">Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚:</label>
      <select id="teamSelect">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚ --</option>
        <option value="A">Ø§Ù„ÙØ±ÙŠÙ‚ (Ø£)</option>
        <option value="B">Ø§Ù„ÙØ±ÙŠÙ‚ (Ø¨)</option>
        <option value="C">Ø§Ù„ÙØ±ÙŠÙ‚ (Ø¬)</option>
      </select>

      <label for="reportSelect">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
      <select id="reportSelect" disabled>
        <option value="">-- Ø§Ø®ØªØ± ØªÙ‚Ø±ÙŠØ±Ù‹Ø§ --</option>
      </select>

      <button class="btn" onclick="window.print()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
    <div class="muted">Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ø®ØªØ± ØªÙ‚Ø±ÙŠØ±Ù‹Ø§ Ø­Ø³Ø¨ <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®</strong> Ùˆ<strong>Ø§Ù„Ù‚Ø·Ø§Ø¹</strong>.</div>
  </div>

  <div class="container">
    <h1>Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)</h1>

    <div id="reportHeader" class="header-grid readonly">
      <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</strong> <span id="projName">â€”</span></div>
      <div><strong>Ø§Ù„ÙØ±ÙŠÙ‚:</strong> <span id="teamName">â€”</span></div>
      <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="repDate">â€”</span></div>
      <div><strong>Ø§Ù„Ù…Ù‚Ø·Ø¹/Ø§Ù„Ù‚Ø·Ø§Ø¹:</strong> <span id="repSection">â€”</span></div>
      <div><strong>Ø§Ù„ÙŠÙˆÙ…:</strong> <span id="repDay">â€”</span></div>
      <div><strong>Ø¥Ø¹Ø¯Ø§Ø¯:</strong> <span id="repPrepared">â€”</span></div>
    </div>

    <div id="reportBody">
      <h2>1) Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ù†Ø¬Ø²Ø© Ø§Ù„ÙŠÙˆÙ…</h2>
      <div id="worksWrap" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>

      <h2>2) Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</h2>
      <div id="laborWrap" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>

      <h2>3) Ø§Ù„Ù…Ø¹Ø¯Ø§Øª</h2>
      <div id="equipWrap" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>

      <h2>4) ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©</h2>
      <div id="safetyWrap" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>

      <h2>5) Ø§Ù„Ù…Ø¹ÙˆÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
      <div id="issuesWrap" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>
    </div>
  </div>

</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // === 1) Ø¥Ø¹Ø¯Ø§Ø¯ Supabase (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ…) ===
  const SUPABASE_URL = "https://scnatcektqebuwyzflgb.supabase.co";         // Ù…Ø«Ø§Ù„: https://xxxx.supabase.co
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjbmF0Y2VrdHFlYnV3eXpmbGdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODIzMDksImV4cCI6MjA3ODM1ODMwOX0.meASFDbwYz9Hy7DOKb7ILeGEwWA8faKH5ukJ-XpfLT8";    // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… anon
  const sb = (SUPABASE_URL && SUPABASE_ANON_KEY) ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

  // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø§ Ø§Ø³ØªØ¹Ù…Ù„Ù†Ø§Ù‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§ Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©)
  const TABLE_HEAD  = 'daily_reports';
  const TABLE_ITEMS = 'daily_report_items';

  // === 2) Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
  const teamSelect   = document.getElementById('teamSelect');
  const reportSelect = document.getElementById('reportSelect');

  teamSelect.addEventListener('change', onTeamChange);
  reportSelect.addEventListener('change', onReportPick);

  async function onTeamChange(){
    clearView();
    const team = teamSelect.value;
    reportSelect.innerHTML = `<option value="">-- Ø§Ø®ØªØ± ØªÙ‚Ø±ÙŠØ±Ù‹Ø§ --</option>`;
    reportSelect.disabled = true;
    if(!team){ return; }

    if(!sb){ alert('Ø±Ø¬Ø§Ø¡Ù‹ ÙØ¹Ù‘Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù.'); return; }

    // Ù†Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙØ±ÙŠÙ‚: (id, report_date, section, project_name)
    const { data, error } = await sb
      .from(TABLE_HEAD)
      .select('id, team, report_date, section, project_name')
      .eq('team', team)
      .order('report_date', { ascending: false })
      .limit(500);

    if(error){ console.error(error); alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.'); return; }

    if(!data || !data.length){
      reportSelect.innerHTML = `<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚</option>`;
      return;
    }

    // Ù†Ù…Ù„Ø£ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ø®ÙŠØ§Ø±: "YYYY-MM-DD â€” Ø§Ù„Ù‚Ø·Ø§Ø¹ X"
    const opts = data.map(r=>{
      const dateTxt = formatDate(r.report_date);
      const sectTxt = r.section ? `â€” ${r.section}` : '';
      const title   = `${dateTxt} ${sectTxt}`;
      return `<option value="${r.id}">${title}</option>`;
    });
    reportSelect.innerHTML = `<option value="">-- Ø§Ø®ØªØ± ØªÙ‚Ø±ÙŠØ±Ù‹Ø§ --</option>` + opts.join('');
    reportSelect.disabled = false;

    // ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù…Ù„Ø¡ Ù„Ø§Ø­Ù‚Ù‹Ø§
    window.__reportsCache = {};
    data.forEach(r => window.__reportsCache[r.id] = r);
  }

  async function onReportPick(){
    clearViewBody();
    const repId = reportSelect.value;
    if(!repId){ return; }

    if(!sb){ alert('Ø±Ø¬Ø§Ø¡Ù‹ ÙØ¹Ù‘Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù.'); return; }

    // 1) Ø§Ù„Ø±Ø£Ø³
    let head = window.__reportsCache?.[repId];
    if(!head){
      const { data: h, error: e1 } = await sb.from(TABLE_HEAD).select('*').eq('id', repId).single();
      if(e1){ console.error(e1); alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.'); return; }
      head = h;
    }
    fillHeader(head);

    // 2) Ø§Ù„ØªÙØ§ØµÙŠÙ„/Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const { data: items, error: e2 } = await sb
      .from(TABLE_ITEMS)
      .select('*')
      .eq('report_id', repId)
      .order('id', { ascending: true });

    if(e2){ console.error(e2); alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.'); return; }

    renderSections(items || []);
  }

  // === 3) Ø§Ù„Ø¹Ø±Ø¶: ØªØ±ÙˆÙŠØ³Ù€Ø© + Ø£Ù‚Ø³Ø§Ù… ===
  function fillHeader(h){
    document.getElementById('projName').textContent  = h.project_name || 'â€”';
    document.getElementById('teamName').textContent  = toTeamLabel(h.team);
    document.getElementById('repDate').textContent   = formatDate(h.report_date);
    document.getElementById('repSection').textContent= h.section || 'â€”';
    document.getElementById('repDay').textContent    = h.report_day || guessDayName(h.report_date);
    document.getElementById('repPrepared').textContent = h.prepared_by || 'â€”';
  }

  function renderSections(items){
    // Ù†ØªÙˆÙ‚Ø¹ item_type Ø¶Ù…Ù†: work | labor | equip | safety | issue
    const works  = items.filter(x=>x.item_type==='work');
    const labor  = items.filter(x=>x.item_type==='labor');
    const equip  = items.filter(x=>x.item_type==='equip');
    const safety = items.filter(x=>x.item_type==='safety');
    const issues = items.filter(x=>x.item_type==='issue');

    // 1) Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
    mountOrEmpty('worksWrap', works.length ? tableWorks(works) : emptyDiv());

    // 2) Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†
    mountOrEmpty('laborWrap', labor.length ? tableLabor(labor) : emptyDiv());

    // 3) Ø§Ù„Ù…Ø¹Ø¯Ø§Øª
    mountOrEmpty('equipWrap', equip.length ? tableEquip(equip) : emptyDiv());

    // 4) Ø§Ù„Ø³Ù„Ø§Ù…Ø©/Ø§Ù„Ø¬ÙˆØ¯Ø©
    mountOrEmpty('safetyWrap', safety.length ? tableSafety(safety) : emptyDiv());

    // 5) Ø§Ù„Ù…Ø¹ÙˆÙ‚Ø§Øª
    mountOrEmpty('issuesWrap', issues.length ? tableIssues(issues) : emptyDiv());
  }

  // === 4) Ù…ÙˆÙ„Ù‘Ø¯Ø§Øª Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·) ===
  function tableWorks(rows){
    const trs = rows.map(r=>`
      <tr>
        <td>${esc(r.task || r.title)}</td>
        <td>${esc(r.description || '')}</td>
        <td>${esc(r.quantity || r.qty || '')}</td>
      </tr>
    `).join('');
    return `
      <table class="summary">
        <thead><tr><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th></tr></thead>
        <tbody>${trs}</tbody>
      </table>
    `;
  }

  function tableLabor(rows){
    const trs = rows.map(r=>`
      <tr>
        <td>${esc(r.role || r.position || '')}</td>
        <td>${esc(r.count || r.number || r.people || '')}</td>
        <td>${esc(r.note || r.notes || '')}</td>
      </tr>
    `).join('');
    return `
      <table class="resources">
        <thead><tr><th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
        <tbody>${trs}</tbody>
      </table>
    `;
  }

  function tableEquip(rows){
    const trs = rows.map(r=>`
      <tr>
        <td>${esc(r.name || r.equipment || '')}</td>
        <td>${esc(r.count || r.number || '')}</td>
        <td>${esc(r.hours || r.runtime_hours || '')}</td>
        <td>${esc(r.status || '')}</td>
      </tr>
    `).join('');
    return `
      <table class="resources">
        <thead><tr><th>Ø§Ù„Ø¢Ù„ÙŠØ©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody>${trs}</tbody>
      </table>
    `;
  }

  function tableSafety(rows){
    const trs = rows.map(r=>`
      <tr>
        <td>${esc(r.item || r.check_item || '')}</td>
        <td class="center">${toCheck(r.checked)}</td>
        <td>${esc(r.note || r.notes || '')}</td>
      </tr>
    `).join('');
    return `
      <table class="safety">
        <thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>âœ”</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
        <tbody>${trs}</tbody>
      </table>
    `;
  }

  function tableIssues(rows){
    const trs = rows.map(r=>`
      <tr>
        <td>${esc(r.issue || r.description || '')}</td>
        <td>${esc(r.action || r.required_action || '')}</td>
        <td>${esc(r.status || '')}</td>
      </tr>
    `).join('');
    return `
      <table>
        <thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° / Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody>${trs}</tbody>
      </table>
    `;
  }

  // === 5) Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===
  function clearView(){
    reportSelect.innerHTML = `<option value="">-- Ø§Ø®ØªØ± ØªÙ‚Ø±ÙŠØ±Ù‹Ø§ --</option>`;
    clearViewBody();
    document.getElementById('projName').textContent='â€”';
    document.getElementById('teamName').textContent='â€”';
    document.getElementById('repDate').textContent='â€”';
    document.getElementById('repSection').textContent='â€”';
    document.getElementById('repDay').textContent='â€”';
    document.getElementById('repPrepared').textContent='â€”';
  }
  function clearViewBody(){
    mountOrEmpty('worksWrap', emptyDiv());
    mountOrEmpty('laborWrap', emptyDiv());
    mountOrEmpty('equipWrap', emptyDiv());
    mountOrEmpty('safetyWrap', emptyDiv());
    mountOrEmpty('issuesWrap', emptyDiv());
  }
  function emptyDiv(){ return `<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>`; }
  function mountOrEmpty(id, html){ const el=document.getElementById(id); if(el) el.innerHTML = html; }

  function esc(s){
    return String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function toCheck(v){ return (v===true || v==='true' || v===1 || v==='1') ? 'âœ”' : 'â€”'; }
  function toTeamLabel(t){
    if(!t) return 'â€”';
    const n = String(t).trim().toUpperCase();
    if(n==='A') return 'Ø§Ù„ÙØ±ÙŠÙ‚ (Ø£)';
    if(n==='B') return 'Ø§Ù„ÙØ±ÙŠÙ‚ (Ø¨)';
    if(n==='C') return 'Ø§Ù„ÙØ±ÙŠÙ‚ (Ø¬)';
    return t;
  }
  function formatDate(d){
    if(!d) return 'â€”';
    try{
      const dt = new Date(d);
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const dd = String(dt.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }catch{ return d; }
  }
  function guessDayName(d){
    if(!d) return 'â€”';
    const days = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
    try{
      const dt = new Date(d); return days[dt.getDay()] || 'â€”';
    }catch{ return 'â€”'; }
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø¨Ø³ÙŠØ·Ø©
  document.addEventListener('DOMContentLoaded', ()=>{
    // Ù„Ø§ Ø´ÙŠØ¡ Ø¥Ø¶Ø§ÙÙŠ â€” ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚
  });
</script>
</body>
</html>
