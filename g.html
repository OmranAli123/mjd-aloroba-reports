<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Ù†Ù…ÙˆØ°Ø¬ ÙØ­Øµ Ø§Ù„Ø®ÙŠØ± Ù„Ù„Ø¢Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª</title>

  <!-- Tailwind (ÙƒÙ…Ø§ ÙÙŠ Ù†Ø³Ø®ØªÙƒ) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Readex+Pro:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --brand-black:#212529; --brand-yellow:#FFC107; --brand-light-gray:#F8F9FA; --brand-medium-gray:#6C757D;
      --brand-border-gray:#DEE2E6; --brand-danger-red:#DC3545; --brand-success:#198754; --brand-info:#0ea5e9;
      --bg-info:rgba(14,165,233,.10); --bg-danger:rgba(220,53,69,.10); --bg-success:rgba(25,135,84,.10);
      --font-title:'Cairo',sans-serif; --font-body:'Readex Pro',sans-serif;
    }
    body{font-family:var(--font-body);background:var(--brand-light-gray);color:var(--brand-black)}
    .form-container{max-width:860px;margin:1.25rem auto;padding:0 1rem}
    .header h1{font-family:var(--font-title);font-weight:900;font-size:2rem;text-align:center;margin:1rem 0 1.25rem}
    .header h1 .highlight{color:var(--brand-yellow)}
    .form-section{background:#fff;border-radius:12px;padding:1.25rem 1.25rem;margin-bottom:1rem;box-shadow:0 8px 20px rgba(0,0,0,.06);border:1px solid var(--brand-border-gray)}
    h2{font-family:var(--font-title);font-weight:700;font-size:1.25rem;text-align:right;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid var(--brand-border-gray)}
    .input-group{margin-bottom:1rem}
    .input-group label{display:block;font-weight:700;margin-bottom:.5rem;color:var(--brand-medium-gray);font-family:var(--font-title)}
    .input-group input[type="text"], .input-group input[type="date"], .input-group input[type="datetime-local"],
    .input-group input[type="number"], .input-group textarea, .input-group select{
      width:100%;padding:.75rem 1rem;border:1px solid var(--brand-border-gray);border-radius:8px;
      font-family:var(--font-body);transition:border-color .2s, box-shadow .2s;background:var(--brand-light-gray)
    }
    .input-group input:focus,.input-group textarea:focus,.input-group select:focus{
      outline:none;border-color:var(--brand-yellow);box-shadow:0 0 0 3px rgba(255,193,7,.2)
    }
    .en-num{direction:ltr;font-family:'Readex Pro','Segoe UI',Tahoma,sans-serif;}
    .checklist-item{border-bottom:1px solid var(--brand-border-gray);padding:1rem 0;border-radius:10px;transition:background-color .2s}
    .checklist-item:last-child{border-bottom:none}
    .checklist-item-header{font-weight:700;color:var(--brand-black);margin-bottom:.75rem;font-size:1.05rem}
    .pill-group{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem}
    .pill{display:flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:999px;border:2px solid var(--brand-border-gray);
      background:var(--brand-light-gray);cursor:pointer;font-weight:600;transition:all .15s}
    .pill input[type="radio"]{display:none}
    .ok-selected{background:var(--bg-success);border-color:var(--brand-success)}
    .faulty-selected{background:var(--bg-danger);border-color:var(--brand-danger-red)}
    .notes-input{width:100%;padding:.65rem .9rem;border:1px solid var(--brand-border-gray);border-radius:8px;background:#fff}
    .notes-required{box-shadow:0 0 0 3px rgba(220,53,69,.18)!important;border-color:var(--brand-danger-red)!important}
    .btn{background:var(--brand-black);color:#fff;padding:1rem 1.25rem;border:none;border-radius:10px;cursor:pointer;
      font-family:var(--font-title);font-weight:800;font-size:1.05rem;width:100%;box-shadow:0 4px 15px rgba(0,0,0,.1);transition:background .2s, transform .2s}
    .btn:hover{background:#3a4149;transform:translateY(-1px)}
    .btn-print{background:#0f172a}
    .btn-save{background:#0ea5e9}
    .btn-save:hover{background:#0a86bd}
    .action-pills .pill{border-width:1px}
    .action-ok-selected{background:var(--bg-success);border-color:var(--brand-success);color:#0f172a}
    .action-report-selected{background:var(--bg-info);border-color:var(--brand-info);color:#0f172a}
    .action-stop-selected{background:var(--bg-danger);border-color:var(--brand-danger-red);color:#0f172a}
    .bg-action-reported{background:var(--bg-info)}
    .bg-action-stop{background:var(--bg-danger)}
    .hint{color:#6b7280;font-size:.9rem}
    @media print{.no-print{display:none !important}body{background:#fff} .form-section{box-shadow:none}}
  </style>
</head>
<body id="pageBody">
  <div class="form-container">
    <form id="checklistForm">
      <header class="header">
        <h1><span class="highlight">Ø§Ù„Ø®ÙŠØ±</span> Ù„Ù„Ø¢Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª</h1>
      </header>

      <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© -->
      <div class="form-section">
        <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
          <div class="input-group">
            <label for="equipment">Ø§Ù„Ø¢Ù„ÙŠØ©:</label>
            <select id="equipment" name="equipment" required>
              <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„ÙŠØ©</option>
              <option>Ø´Ø§Ø­Ù†Ø© Ø³ÙƒØ§Ù†ÙŠØ§</option><option>Ø´Ø§Ø­Ù†Ø© Ø¯Ù†Ø¨Ø±</option><option>Ø§ÙŠÙÙƒÙˆ Ù‚Ù„Ù‘Ø§Ø¨</option>
              <option>Ø­ÙØ§Ø± 1</option><option>Ø­ÙØ§Ø± 2</option><option>Ø­ÙØ§Ø± Ø¹Ù‚Ø±Ø¨</option>
              <option>Ù„ÙˆØ¯Ø± 48</option><option>Ù„ÙˆØ¯Ø± 56-1</option><option>Ù„ÙˆØ¯Ø± 56-2</option>
              <option>Ù…Ø¯Ø­Ù„Ø© 4 Ø·Ù†</option><option>ØµÙ‡Ø±ÙŠØ¬ Ù…ÙŠØ§Ù‡ 12 Ù…Â³</option>
              <option>Ø¨ÙˆØ¨ ÙƒØ§Øª</option><option>Ø¨ÙˆØ±ØªØ± Ø¯Ø¨Ù„</option><option>Ø¨ÙˆØ±ØªØ±</option>
            </select>
          </div>
          <div class="input-group">
            <label for="meter">Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª / Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙˆÙ…ØªØ±Ø§Øª:</label>
            <input type="number" id="meter" name="meter" inputmode="decimal" lang="en" pattern="[0-9.]*" placeholder="Ø§ÙƒØªØ¨ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©" class="en-num">
          </div>
          <div class="input-group">
            <label for="dateDisplay">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª:</label>
            <input type="text" id="dateDisplay" class="bg-gray-200 cursor-not-allowed en-num" lang="en" dir="ltr" readonly placeholder="YYYY/MM/DD HH:MM">
            <input type="hidden" id="date" name="date">
            <div class="hint">ÙŠÙØ¹Ø¨Ù‘Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù† (ÙŠÙØ­Ø¯Ù‘Ø« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©).</div>
          </div>
          <div class="input-group">
            <label for="operator">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØºÙ„/Ø§Ù„ÙØ§Ø­Øµ:</label>
            <input type="text" id="operator" name="operator" list="operators" placeholder="Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù…">
          </div>
          <datalist id="operators">
            <option value="Ø³Ø§Ù„Ù… Ø§Ù„Ù‚Ø¯Ø§Ø±"><option value="Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†"><option value="ÙˆØ³ÙŠÙ… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙŠ">
            <option value="Ù‡Ø¯ÙŠØ© Ø§Ù„Ø·Ø±Ù„ÙŠ"><option value="Ø¹Ù…Ø± Ø³Ø§Ù…ÙŠ"><option value="ÙŠØ­ÙŠ Ø²ÙƒØ±ÙŠØ§">
            <option value="Ù…Ø­Ù…Ø¯ Ø§Ù„ØªÙˆÙ†Ø³ÙŠ"><option value="Ù…Ø­Ù…Ø¯ Ù…Ù…Ø¯ÙˆØ­"><option value="Ù…Ø­Ù…Ø¯ Ø³Ø§Ù…ÙŠ">
            <option value="Ù…ØµØ¨Ø§Ø­ Ø´ÙƒØ±"><option value="Ù…Ø­Ù…Ø¯ Ø³Ø§Ù„Ù…"><option value="ØµÙ„Ø§Ø­ Ø¹Ø¨Ø¯Ø§Ù„ÙˆÙ‡Ø§Ø¨"><option value="Ø­Ø§ØªÙ… Ø¨Ù† ÙØ±Ø¬">
          </datalist>
        </div>
      </div>

      <!-- 1. Ø§Ù„ÙØ­Øµ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ -->
      <div class="form-section">
        <h2>1. Ø§Ù„ÙØ­Øµ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„</h2>

        <div class="checklist-item" data-group="leak_check">
          <div class="checklist-item-header">Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØ³Ø±ÙŠØ¨Ø§Øª (Ø²ÙŠØªØŒ ÙˆÙ‚ÙˆØ¯ØŒ Ø³Ø§Ø¦Ù„ ØªØ¨Ø±ÙŠØ¯)</div>
          <div class="pill-group">
            <label class="pill"><input type="radio" name="leak_check" value="ok"> Ø³Ù„ÙŠÙ…</label>
            <label class="pill"><input type="radio" name="leak_check" value="faulty"> ØºÙŠØ± Ø³Ù„ÙŠÙ…</label>
          </div>
          <input type="text" name="leak_check_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="notes-input">
        </div>

        <div class="checklist-item" data-group="tires_tracks">
          <div class="checklist-item-header">ÙØ­Øµ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª/Ø§Ù„Ø¬Ù†Ø§Ø²ÙŠØ± (Ø¶ØºØ·ØŒ ØªØ¢ÙƒÙ„ØŒ ØªÙ„ÙØŒ Ø´Ø¯)</div>
          <div class="pill-group">
            <label class="pill"><input type="radio" name="tires_tracks" value="ok"> Ø³Ù„ÙŠÙ…</label>
            <label class="pill"><input type="radio" name="tires_tracks" value="faulty"> ØºÙŠØ± Ø³Ù„ÙŠÙ…</label>
          </div>
          <input type="text" name="tires_tracks_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="notes-input">
        </div>

        <div class="checklist-item" data-group="attachments">
          <div class="checklist-item-header">ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø­Ù‚Ø§Øª (Ø¨ÙƒØªØŒ Ø´ÙØ±Ø©ØŒ Ø´ÙˆÙƒØ©)</div>
          <div class="pill-group">
            <label class="pill"><input type="radio" name="attachments" value="ok"> Ø³Ù„ÙŠÙ…</label>
            <label class="pill"><input type="radio" name="attachments" value="faulty"> ØºÙŠØ± Ø³Ù„ÙŠÙ…</label>
          </div>
          <input type="text" name="attachments_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="notes-input">
        </div>

        <div class="checklist-item" data-group="visibility">
          <div class="checklist-item-header">Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø²Ø¬Ø§Ø¬ ÙˆØ§Ù„Ù…Ø±Ø§ÙŠØ§ ÙˆØ§Ù„Ø¥Ø¶Ø§Ø¡Ø©</div>
          <div class="pill-group">
            <label class="pill"><input type="radio" name="visibility" value="ok"> Ø³Ù„ÙŠÙ…</label>
            <label class="pill"><input type="radio" name="visibility" value="faulty"> ØºÙŠØ± Ø³Ù„ÙŠÙ…</label>
          </div>
          <input type="text" name="visibility_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="notes-input">
        </div>

        <div class="checklist-item" data-group="fire_extinguisher">
          <div class="checklist-item-header">ÙˆØ¬ÙˆØ¯ ÙˆØªØ¬Ù‡ÙŠØ² Ø·ÙØ§ÙŠØ© Ø§Ù„Ø­Ø±ÙŠÙ‚</div>
          <div class="pill-group">
            <label class="pill"><input type="radio" name="fire_extinguisher" value="ok"> Ø³Ù„ÙŠÙ…</label>
            <label class="pill"><input type="radio" name="fire_extinguisher" value="faulty"> ØºÙŠØ± Ø³Ù„ÙŠÙ…</label>
          </div>
          <input type="text" name="fire_extinguisher_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="notes-input">
        </div>

        <div class="checklist-item" data-group="steps_handles">
          <div class="checklist-item-header">Ø³Ù„Ø§Ù…Ø© ÙˆÙ†Ø¸Ø§ÙØ© Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø³Ù„Ù… ÙˆÙ…Ù‚Ø§Ø¨Ø¶ Ø§Ù„ÙŠØ¯</div>
          <div class="pill-group">
            <label class="pill"><input type="radio" name="steps_handles" value="ok"> Ø³Ù„ÙŠÙ…</label>
            <label class="pill"><input type="radio" name="steps_handles" value="faulty"> ØºÙŠØ± Ø³Ù„ÙŠÙ…</label>
          </div>
          <input type="text" name="steps_handles_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="notes-input">
        </div>
      </div>

      <!-- 2. Ø§Ù„ÙØ­Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø© -->
      <div class="form-section">
        <h2>2. Ø§Ù„ÙØ­Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø©</h2>

        <div class="checklist-item" data-group="cabin_cleanliness">
          <div class="checklist-item-header">Ù†Ø¸Ø§ÙØ© ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒØ§Ø¨ÙŠÙ†Ø©</div>
          <div class="pill-group">
            <label class="pill"><input type="radio" name="cabin_cleanliness" value="ok"> Ø³Ù„ÙŠÙ…</label>
            <label class="pill"><input type="radio" name="cabin_cleanliness" value="faulty"> ØºÙŠØ± Ø³Ù„ÙŠÙ…</label>
          </div>
          <input type="text" name="cabin_cleanliness_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="notes-input">
        </div>

        <div class="checklist-item" data-group="wipers">
          <div class="checklist-item-header">Ø§Ù„Ù…Ø³Ù‘Ø§Ø­Ø§Øª (Ø¹Ù…Ù„ Ø§Ù„Ø´ÙØ±Ø§Øª/Ø®Ø²Ø§Ù† Ø§Ù„Ù…Ø§Ø¡)</div>
          <div class="pill-group">
            <label class="pill"><input type="radio" name="wipers" value="ok"> Ø³Ù„ÙŠÙ…</label>
            <label class="pill"><input type="radio" name="wipers" value="faulty"> ØºÙŠØ± Ø³Ù„ÙŠÙ…</label>
          </div>
          <input type="text" name="wipers_notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="notes-input">
        </div>
      </div>

      <!-- 3. Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° -->
      <div class="form-section">
        <h2>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°</h2>
        <div class="pill-group action-pills" id="actionGroup" role="radiogroup">
          <label class="pill" data-action="ok"><input type="radio" name="action" value="ok"> ØµØ§Ù„Ø­Ø© Ù„Ù„Ø¹Ù…Ù„</label>
          <label class="pill" data-action="reported"><input type="radio" name="action" value="reported"> ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù„Ù„ØµÙŠØ§Ù†Ø©</label>
          <label class="pill" data-action="stop"><input type="radio" name="action" value="stop"> Ø¥ÙŠÙ‚Ø§Ù Ø­ØªÙ‰ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</label>
        </div>
        <p class="text-sm text-slate-600 mt-2">* ÙÙŠ Ø­Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± "ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº" Ø£Ùˆ "Ø¥ÙŠÙ‚Ø§Ù"ØŒ ØªÙØµØ¨Ø­ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆÙŠØªÙ… ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆÙÙ‚ Ø§Ù„Ø­Ø§Ù„Ø©.</p>
      </div>

      <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© -->
      <div class="form-section">
        <h2>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© / Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù†Ù‡Ø§</h2>
        <div class="input-group">
          <textarea id="additional_notes" name="additional_notes" rows="5" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."></textarea>
        </div>
      </div>

      <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
      <div class="form-section no-print">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <button type="button" id="btnSave" class="btn btn-save">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button type="button" id="btnPrint" class="btn btn-print">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
        </div>
        <p id="saveHint" class="hint mt-3"></p>
      </div>

      <p id="errorBox" class="text-red-600 font-bold mt-3 hidden">ÙØ¶Ù„Ø§Ù‹ Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.</p>
    </form>
  </div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // ============= Ø¥Ø¹Ø¯Ø§Ø¯ Supabase (ØºÙŠÙ‘Ø± Ø§Ù„Ù‚ÙŠÙ…) =============
    const SUPABASE_URL = "https://scnatcektqebuwyzflgb.supabase.co";      // Ù…Ø«Ø§Ù„: https://xxxx.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjbmF0Y2VrdHFlYnV3eXpmbGdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODIzMDksImV4cCI6MjA3ODM1ODMwOX0.meASFDbwYz9Hy7DOKb7ILeGEwWA8faKH5ukJ-XpfLT8"; // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… anon
    const sb = (SUPABASE_URL && SUPABASE_ANON_KEY) ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // ØªØ­ÙˆÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©/ÙØ§Ø±Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    function toEnglishDigits(str){
      if(!str) return str;
      const mapAr = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
      const mapFa = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
      return str.replace(/[Ù -Ù©]/g, d => mapAr.indexOf(d))
                .replace(/[Û°-Û¹]/g, d => mapFa.indexOf(d));
    }

    const form = document.getElementById('checklistForm');
    const errorBox = document.getElementById('errorBox');
    const pageBody = document.getElementById('pageBody');
    const additionalNotes = document.getElementById('additional_notes');
    const saveHint = document.getElementById('saveHint');

    // Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¨Ù†ÙˆØ¯ (ØªÙ„ÙˆÙŠÙ† ÙˆÙØ±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù†Ø¯ "ØºÙŠØ± Ø³Ù„ÙŠÙ…")
    function setupChecklistBehaviour(){
      const items = document.querySelectorAll('.checklist-item');
      items.forEach(item => {
        const group = item.getAttribute('data-group');
        if(!group) return;
        const notes = item.querySelector(`input[name="${group}_notes"], textarea[name="${group}_notes"]`);
        const pills = item.querySelectorAll('.pill');

        function applyState(){
          const selected = item.querySelector(`input[type="radio"][name="${group}"]:checked`);
          item.classList.remove('ok-selected','faulty-selected');
          pills.forEach(p=> p.classList.remove('ok-selected','faulty-selected'));
          if(notes){ notes.classList.remove('notes-required'); notes.removeAttribute('required'); }
          if(selected){
            if(selected.value === 'ok'){
              item.classList.add('ok-selected');
              pills.forEach(p=>{ if(p.querySelector('input').value==='ok') p.classList.add('ok-selected'); });
            }else{
              item.classList.add('faulty-selected');
              pills.forEach(p=>{ if(p.querySelector('input').value==='faulty') p.classList.add('faulty-selected'); });
              if(notes){
                notes.setAttribute('required','required');
                notes.classList.add('notes-required');
                notes.placeholder='Ù…Ø·Ù„ÙˆØ¨: Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ø¹Ø¯Ù… Ø§Ù„Ø³Ù„Ø§Ù…Ø©';
              }
            }
          }
        }

        item.querySelectorAll('input[type="radio"]').forEach(r=> r.addEventListener('change', applyState));
        applyState();
      });
    }

    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆÙØ±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ "ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº" Ø£Ùˆ "Ø¥ÙŠÙ‚Ø§Ù"
    function setupActionPills(){
      const container = document.getElementById('actionGroup');
      if(!container) return;
      const map = { ok:'action-ok-selected', reported:'action-report-selected', stop:'action-stop-selected' };
      function apply(){
        const selected = container.querySelector('input[type="radio"]:checked');
        container.querySelectorAll('.pill').forEach(p=> p.classList.remove('action-ok-selected','action-report-selected','action-stop-selected'));
        pageBody.classList.remove('bg-action-reported','bg-action-stop');
        additionalNotes.removeAttribute('required');
        additionalNotes.classList.remove('notes-required');

        if(selected){
          const act = selected.parentElement.getAttribute('data-action');
          selected.parentElement.classList.add(map[act]);
          if(act === 'reported'){
            pageBody.classList.add('bg-action-reported');
            additionalNotes.setAttribute('required','required');
            additionalNotes.classList.add('notes-required');
            additionalNotes.placeholder = 'Ù…Ø·Ù„ÙˆØ¨: Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº/Ø§Ù„Ø®Ù„Ù„.';
          }else if(act === 'stop'){
            pageBody.classList.add('bg-action-stop');
            additionalNotes.setAttribute('required','required');
            additionalNotes.classList.add('notes-required');
            additionalNotes.placeholder = 'Ù…Ø·Ù„ÙˆØ¨: Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù ÙˆØ®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.';
          }
        }
      }
      container.querySelectorAll('input[type="radio"]').forEach(r=> r.addEventListener('change', apply));
      apply();
    }

    document.getElementById('btnPrint')?.addEventListener('click', ()=> window.print());

    // Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ form Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    form?.addEventListener('submit', function(e){ e.preventDefault(); });

    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¢Ù† (ÙŠØªØ­Ø¯Ù‘Ø« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©)
    (function(){
      const pad = n => String(n).padStart(2,'0');
      function updateNow(){
        const hiddenDate = document.getElementById('date');       // ISO
        const dateDisplay = document.getElementById('dateDisplay'); // Ù…Ø±Ø¦ÙŠ ÙÙ‚Ø·
        if(!hiddenDate || !dateDisplay) return;
        const now = new Date(); now.setSeconds(0,0);
        const iso = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        const display = `${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
        hiddenDate.value = iso;
        dateDisplay.value = toEnglishDigits(display);
      }
      if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', updateNow); } else { updateNow(); }
      setInterval(updateNow, 60000);
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) updateNow(); });
    })();

    // ===== Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† ÙˆØ§Ø­Ø¯
    function collectFormData(){
      const equipment = document.getElementById('equipment')?.value || '';
      const meterRaw  = document.getElementById('meter')?.value || '';
      const meter     = toEnglishDigits(meterRaw);
      const readingAt = document.getElementById('date')?.value || '';   // ISO (yyyy-mm-ddThh:mm)
      const operator  = document.getElementById('operator')?.value || '';
      const actionEl  = document.querySelector('#actionGroup input[type="radio"]:checked');
      const action    = actionEl ? actionEl.value : null;
      const addNotes  = document.getElementById('additional_notes')?.value || '';

      // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ­Øµ
      const itemsObj = {};
      document.querySelectorAll('.checklist-item').forEach(item=>{
        const group = item.getAttribute('data-group');
        if(!group) return;
        const statusEl = item.querySelector(`input[type="radio"][name="${group}"]:checked`);
        const notesEl  = item.querySelector(`input[name="${group}_notes"], textarea[name="${group}_notes"]`);
        itemsObj[group] = {
          status: statusEl ? statusEl.value : null,
          notes : notesEl ? notesEl.value : ''
        };
      });

      return {
        equipment,
        meter: meter ? Number(meter) : null,
        reading_at: readingAt ? new Date(readingAt).toISOString() : new Date().toISOString(),
        operator,
        action,
        additional_notes: addNotes,
        items: itemsObj
      };
    }

    // ===== ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
    function simpleValidate(payload){
      if(!payload.equipment){ return 'Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„ÙŠØ©.'; }
      if(!payload.action){ return 'Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°".'; }
      // Ø¥Ù† ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© reported/stop ÙŠÙ„Ø²Ù… Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©
      if((payload.action==='reported' || payload.action==='stop') && !payload.additional_notes.trim()){
        return 'Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº" Ø£Ùˆ "Ø¥ÙŠÙ‚Ø§Ù" ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©.';
      }
      // Ù„Ø£ÙŠ Ø¨Ù†Ø¯ Ù…Ø®ØªØ§Ø± "ØºÙŠØ± Ø³Ù„ÙŠÙ…" ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù„Ù‡ Ù…Ù„Ø§Ø­Ø¸Ø©
      for(const [key,val] of Object.entries(payload.items)){
        if(val && val.status==='faulty' && !(val.notes||'').trim()){
          return 'Ù‡Ù†Ø§Ùƒ Ø¨Ù†ÙˆØ¯ ØºÙŠØ± Ø³Ù„ÙŠÙ…Ø© Ø¨Ø¯ÙˆÙ† Ù…Ù„Ø§Ø­Ø¸Ø§Øª. Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒÙ…Ù„Ù‡Ø§.';
        }
      }
      return null;
    }

    // ===== Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Supabase
    document.getElementById('btnSave')?.addEventListener('click', async ()=>{
      if(!sb){
        saveHint.textContent = 'âš ï¸ Ø±Ø¬Ø§Ø¡ Ø¶Ø¨Ø· SUPABASE_URL Ùˆ SUPABASE_ANON_KEY Ø£ÙˆÙ„Ù‹Ø§.';
        saveHint.style.color = '#dc2626';
        return;
      }
      saveHint.textContent = ''; saveHint.style.color = '#6b7280';

      const payload = collectFormData();
      const err = simpleValidate(payload);
      if(err){
        saveHint.textContent = err;
        saveHint.style.color = '#dc2626';
        return;
      }

      try{
        // Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        const { data, error } = await sb
          .from('equipment_checks')
          .insert({
            equipment: payload.equipment,
            meter: payload.meter,
            reading_at: payload.reading_at,
            operator: payload.operator,
            action: payload.action,
            additional_notes: payload.additional_notes,
            items: payload.items
          })
          .select('id, created_at')
          .single();

        if(error) throw error;

        saveHint.innerHTML = `âœ”ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­. <span class="en-num">ID: ${data.id}</span>`;
        saveHint.style.color = '#15803d';
      }catch(e){
        console.error(e);
        saveHint.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„.';
        saveHint.style.color = '#dc2626';
      }
    });

    // ØªÙ‡ÙŠØ¦Ø©
    setupChecklistBehaviour();
    setupActionPills();
  </script>
</body>
</html>
